<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaxiliv - Animal Health & Vaccine Tracker</title>

    <meta name="theme-color" content="#059669">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/images/icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0FDF4; }
        .text-brand { color: #047857; } .bg-brand { background-color: #047857; }
        .border-brand { border-color: #047857; } .accent-brand { accent-color: #047857; }
        
        #background-container {
            background-image: url('assets/images/background-blurred.jpg');
            background-size: cover;
            background-position: center;
        }
        #background-container::after {
            content: ''; position: absolute; inset: 0;
            background-color: rgba(240, 253, 244, 0.7);
        }

        .content-section { display: none; }
        .content-section.active { display: block; animation: slideInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { box-shadow: 0 -4px 12px rgba(0,0,0,0.1); }
        .nav-btn { transition: all 0.2s ease-in-out; }
        .nav-btn.active { color: #047857; transform: translateY(-4px); }
        .nav-btn.active .nav-icon { transform: scale(1.1); }
        .nav-btn.active .nav-text { font-weight: 600; }
        
        .modal-overlay { transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .modal-overlay:not(.visible) .modal-content { transform: translateY(100%); }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        
        .health-modal-content { max-height: 85vh; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .vaccine-row.completed { background-color: #dcfce7; }
        .vaccine-row.completed td { text-decoration: line-through; color: #166534; }
        .vaccine-row.pending { background-color: #fee2e2; }
        .vaccine-row.due { background-color: #fef9c3; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { font-family: 'Inter', sans-serif; }
        .vet-popup h3 { font-weight: 700; color: #047857; margin: 0 0 4px; }
        .vet-popup p { margin: 2px 0; font-size: 12px; color: #4b5563; }
        .vet-popup a { display: block; margin-top: 8px; padding: 6px; text-align: center; background-color: #047857; color: white; border-radius: 6px; text-decoration: none; font-weight: 600; transition: background-color 0.2s; }
        .vet-popup a:hover { background-color: #059669; }
        .interactive-btn { transition: all 0.2s ease-in-out; }
        .interactive-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .interactive-btn:active { transform: scale(0.98); }

        .sr-only {
            position: absolute; width: 1px; height: 1px;
            padding: 0; margin: -1px; overflow: hidden;
            clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* Styles for the 'About' Section Animation */
        .about-p {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .about-p.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="text-gray-800">

<div id="splash-screen" class="fixed inset-0 bg-emerald-50 flex flex-col items-center justify-center z-[100] transition-opacity duration-700 ease-out">
    <div class="flex items-center space-x-4">
        <div class="w-20 h-20 rounded-full bg-white border-4 border-brand flex items-center justify-center shadow-lg">
            <img src="assets/images/logo.png" alt="Vaxiliv Logo" class="w-12 h-12">
        </div>
        <h1 class="text-5xl font-bold text-brand">Vaxiliv</h1>
    </div>
    <p class="mt-4 text-gray-500">Your Animal Health Partner</p>
</div>

<div id="background-container" class="fixed inset-0 z-0"></div>

<div id="app" class="relative z-10 max-w-5xl mx-auto bg-white/80 backdrop-blur-sm shadow-2xl flex flex-col h-screen md:rounded-lg overflow-hidden">
    <header class="bg-emerald-50/80 backdrop-blur-sm p-4 md:rounded-t-lg shadow-md flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full overflow-hidden bg-white border-2 border-brand flex items-center justify-center">
                    <img src="assets/images/logo.png" alt="Vaxiliv Logo" class="w-8 h-8">
                </div>
                <h1 class="text-2xl font-bold text-brand">Vaxiliv</h1>
            </div>
            <div>
                <label for="language-switcher" class="sr-only">Choose a language</label>
                 <select id="language-switcher" class="bg-white border border-brand text-brand text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-1.5">
                    <option value="en">English</option>
                    <option value="sw">Kiswahili</option>
                    <option value="so">Soomaali</option>
                </select>
            </div>
        </div>
    </header>

    <main class="p-4 pb-24 flex-grow overflow-y-auto">

        <section id="tips" class="content-section active">
            <h2 class="text-xl font-bold text-brand mb-1" data-key="tips_title"></h2>
            <p class="text-gray-600 mb-4" data-key="tips_subtitle"></p>
            <div id="tips-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            <div id="vaxiliv-reminder-card" class="mt-6 bg-emerald-100/80 border-l-4 border-emerald-500 text-emerald-800 p-4 rounded-md shadow-sm"></div>
        </section>

        <section id="schedules" class="content-section">
            <div class="bg-yellow-50/80 p-4 rounded-lg border border-yellow-200 shadow-sm mb-6">
                <h3 class="font-semibold text-lg mb-3 text-yellow-800 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    <span data-key="reminders_title"></span>
                </h3>
                <div id="notification-permission-area">
                    <p class="text-sm text-yellow-700 mb-3" data-key="reminders_description"></p>
                    <button id="enable-notifications-btn" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg interactive-btn" data-key="reminders_enable_button"></button>
                    <p id="notification-status" class="text-xs text-center text-gray-500 mt-2"></p>
                </div>
                <div id="upcoming-vaccinations-list" class="mt-4 space-y-2"></div>
            </div>
            <div class="bg-gray-50/80 p-4 rounded-lg border border-gray-200 shadow-sm mb-6">
                <h3 class="font-semibold text-lg mb-3" data-key="tracker_add_animal"></h3>
                <div class="space-y-4">
                    <div>
                        <label for="animal-category" class="block text-sm font-medium text-gray-700" data-key="tracker_animal_category"></label>
                        <select id="animal-category" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md accent-brand"></select>
                    </div>
                     <div>
                        <label for="animal-type" class="block text-sm font-medium text-gray-700" data-key="tracker_animal_type"></label>
                         <div class="flex items-center space-x-3">
                             <select id="animal-type" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md accent-brand"></select>
                             <div id="animal-icon-preview" class="w-12 h-12 mt-1 flex items-center justify-center bg-gray-200 rounded-md overflow-hidden"></div>
                         </div>
                    </div>
                     <div>
                        <label for="animal-name" class="block text-sm font-medium text-gray-700" data-key="tracker_animal_name"></label>
                         <input type="text" id="animal-name" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="animal-dob" class="block text-sm font-medium text-gray-700" data-key="tracker_animal_dob"></label>
                         <input type="date" id="animal-dob" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                    <button id="add-animal-btn" class="w-full bg-brand text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 interactive-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                        <span data-key="tracker_add_button"></span>
                    </button>
                </div>
            </div>
            <div id="schedules-container" class="mt-6 space-y-4"></div>
            <h2 class="text-xl font-bold text-brand mb-4 mt-8" data-key="schedules_general_title"></h2>
            <p class="text-gray-600 mb-4" data-key="schedules_general_subtitle"></p>
            <div id="static-schedules-container" class="space-y-3"></div>
        </section>

        <section id="locator" class="content-section">
            <h2 class="text-xl font-bold text-brand mb-1" data-key="locator_title"></h2>
            <p class="text-gray-600 mb-4" data-key="locator_subtitle"></p>
            <div id="map" class="w-full h-96 rounded-lg border border-gray-300 shadow-sm bg-gray-200"></div>
            <p id="map-status" class="text-xs text-center text-gray-500 mt-2" data-key="locator_map_loading"></p>
        </section>

        <section id="amr" class="content-section">
            <h2 class="text-xl font-bold text-brand mb-2" data-key="amr_title"></h2>
            <p class="text-gray-600 italic mb-4" data-key="amr_quote"></p>
            <div class="space-y-6 text-gray-700">
                <img src="assets/images/amr_visual.jpg" alt="Antimicrobial Resistance Visual" class="w-full h-48 object-cover rounded-lg shadow-md mb-4">
                <p data-key="amr_intro"></p>
                <div>
                    <h3 class="font-bold text-lg text-brand mb-2" data-key="amr_farm_title"></h3>
                    <div class="pl-4 border-l-4 border-emerald-300 space-y-3">
                        <div><h4 class="font-semibold" data-key="amr_farm_how_title"></h4><ul class="list-disc list-inside text-sm space-y-1 mt-1" data-key="amr_farm_how_list"></ul></div>
                        <div><h4 class="font-semibold text-red-600" data-key="amr_farm_signs_title"></h4><ul class="list-disc list-inside text-sm space-y-1 mt-1" data-key="amr_farm_signs_list"></ul></div>
                        <div><h4 class="font-semibold text-green-700" data-key="amr_farm_what_to_do_title"></h4><ul class="list-disc list-inside text-sm space-y-1 mt-1" data-key="amr_farm_what_to_do_list"></ul></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-brand mb-2" data-key="amr_pets_title"></h3>
                    <div class="pl-4 border-l-4 border-emerald-300 space-y-3">
                        <div><h4 class="font-semibold" data-key="amr_pets_mistakes_title"></h4><ul class="list-disc list-inside text-sm space-y-1 mt-1" data-key="amr_pets_mistakes_list"></ul></div>
                        <div><h4 class="font-semibold text-green-700" data-key="amr_pets_practices_title"></h4><ul class="list-disc list-inside text-sm space-y-1 mt-1" data-key="amr_pets_practices_list"></ul></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-brand mb-2" data-key="amr_one_health_title"></h3>
                    <p data-key="amr_one_health_p1"></p>
                    <p class="mt-2" data-key="amr_one_health_p2"></p>
                </div>
                <div class="mt-6 bg-emerald-100/80 border-l-4 border-emerald-500 text-emerald-800 p-4 rounded-md shadow-sm">
                    <h4 class="font-bold" data-key="amr_vaxiliv_message_title"></h4>
                    <p class="italic" data-key="amr_vaxiliv_message_content"></p>
                </div>
            </div>
        </section>
        
        <section id="about" class="content-section">
            <h2 class="text-xl font-bold text-brand mb-4" data-key="about_title"></h2>
            <img src="assets/images/about_hero.jpg" alt="Vaxiliv Mission Visual" class="w-full h-48 object-cover rounded-lg shadow-md mb-4">
            <div data-key="about_content" class="space-y-4 text-gray-800 leading-relaxed"></div>
        </section>

    </main>

    <footer class="bottom-nav fixed bottom-0 left-0 right-0 max-w-5xl mx-auto bg-white/80 backdrop-blur-sm md:rounded-b-lg border-t grid grid-cols-5 gap-1 p-2 z-20">
        <button data-tab="tips" class="nav-btn flex flex-col items-center justify-center text-gray-500 text-xs p-1 rounded-md">
            <svg class="nav-icon w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><title>Health Tips</title><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            <span class="nav-text" data-key="tab_tips"></span>
        </button>
        <button data-tab="schedules" class="nav-btn flex flex-col items-center justify-center text-gray-500 text-xs p-1 rounded-md">
            <svg class="nav-icon w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><title>Schedules</title><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="nav-text" data-key="tab_schedules"></span>
        </button>
        <button data-tab="locator" class="nav-btn flex flex-col items-center justify-center text-gray-500 text-xs p-1 rounded-md">
            <svg class="nav-icon w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><title>Vet Locator</title><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657 13.414 20.9a2 2 0 0 1-2.827 0l-4.244-4.243a8 8 0 1 1 11.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/></svg>
            <span class="nav-text" data-key="tab_locator"></span>
        </button>
        <button data-tab="amr" class="nav-btn flex flex-col items-center justify-center text-gray-500 text-xs p-1 rounded-md">
            <svg class="nav-icon w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><title>Antimicrobial Resistance</title><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 0 1-7 7m0 0a7 7 0 0 1-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 0 1-3-3V5a3 3 0 1 1 6 0v6a3 3 0 0 1-3 3z"/></svg>
            <span class="nav-text" data-key="tab_amr"></span>
        </button>
        <button data-tab="about" class="nav-btn flex flex-col items-center justify-center text-gray-500 text-xs p-1 rounded-md">
            <svg class="nav-icon w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><title>About</title><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
            <span class="nav-text" data-key="tab_about"></span>
        </button>
    </footer>
</div>

<div id="modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 opacity-0 invisible">
    <div class="modal-content bg-white p-6 rounded-t-lg w-full max-w-5xl text-center">
        <p id="modal-message" class="mb-4"></p>
        <button id="modal-close" class="bg-brand text-white font-semibold py-2 px-6 rounded-lg interactive-btn" data-key="modal_ok_button"></button>
    </div>
</div>

<div id="health-tip-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-end justify-center z-40 opacity-0 invisible">
    <div class="modal-content health-modal-content bg-gray-50 rounded-t-lg w-full max-w-5xl flex flex-col">
        <header id="health-modal-header" class="p-4 border-b bg-white rounded-t-lg flex items-center justify-between sticky top-0"></header>
        <div id="health-modal-body" class="p-4 overflow-y-auto"></div>
        <footer class="p-3 bg-gray-100 border-t">
             <button id="health-modal-close" class="w-full bg-brand text-white font-semibold py-2 px-6 rounded-lg interactive-btn" data-key="modal_close_button"></button>
        </footer>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('ServiceWorker registration successful'))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const APP_STORAGE_KEY = 'vaxiliv_animals_v12';
        const LANG_STORAGE_KEY = 'vaxiliv_language';
        
        let animals = [];
        let currentLang = 'en';
        let map = null;
        let appData = {};
        let vetsData = [];

        const animalImages = { 
            dog: 'assets/images/animals/dog.png', cat: 'assets/images/animals/cat.png', 
            cow: 'assets/images/animals/cow.png', goat: 'assets/images/animals/goat.png', 
            sheep: 'assets/images/animals/sheep.png', pig: 'assets/images/animals/pig.png', 
            sheep_goat: 'assets/images/animals/sheep_goat.png', chicken: 'assets/images/animals/chicken.png'
        };

        const navButtons = document.querySelectorAll('.nav-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const languageSwitcher = document.getElementById('language-switcher');
        const tipsGrid = document.getElementById('tips-grid');
        const reminderCard = document.getElementById('vaxiliv-reminder-card');
        const healthTipModal = document.getElementById('health-tip-modal');
        const healthModalHeader = document.getElementById('health-modal-header');
        const healthModalBody = document.getElementById('health-modal-body');
        const healthModalCloseBtn = document.getElementById('health-modal-close');
        const animalCategorySelect = document.getElementById('animal-category');
        const animalTypeSelect = document.getElementById('animal-type');
        const addAnimalBtn = document.getElementById('add-animal-btn');
        const schedulesContainer = document.getElementById('schedules-container');
        const staticSchedulesContainer = document.getElementById('static-schedules-container');
        const animalIconPreview = document.getElementById('animal-icon-preview');
        const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
        const notificationStatus = document.getElementById('notification-status');
        const upcomingVaccinationsList = document.getElementById('upcoming-vaccinations-list');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close');

        async function loadData() {
            try {
                const [dataResponse, vetsResponse] = await Promise.all([
                    fetch('./data.json'),
                    fetch('./vets.json')
                ]);
                if (!dataResponse.ok || !vetsResponse.ok) throw new Error('Network response was not ok.');
                appData = await dataResponse.json();
                vetsData = await vetsResponse.json();
                return true;
            } catch (error) {
                console.error('Failed to load application data:', error);
                document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600"><h1 class="text-2xl font-bold">Failed to load app data</h1><p>Please check your connection and try again.</p></div>`;
                return false;
            }
        }

        function initMap() {
            if (map) { setTimeout(() => map.invalidateSize(), 1); return; }
            const mapStatus = document.getElementById('map-status');
            const defaultCoords = [-1.286389, 36.817223];
            map = L.map('map').setView(defaultCoords, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            map.locate({setView: true, maxZoom: 14});
            map.on('locationfound', e => { L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup(); L.circle(e.latlng, e.accuracy).addTo(map); });
            map.on('locationerror', e => mapStatus.textContent = 'Could not find your location. Showing vets around Nairobi.');

            const vetIcon = L.icon({ iconUrl: 'assets/images/icons/vet-map-pin.png', iconSize: [32, 40], iconAnchor: [16, 40], popupAnchor: [0, -40] });
            vetsData.forEach(vet => {
                const callButtonText = appData[currentLang].locator_call_button || 'Call Now';
                const popupContent = `<div class="vet-popup"><h3>${vet.name}</h3><p>${vet.address}</p><a href="tel:${vet.tel}" class="interactive-btn">${callButtonText}</a></div>`;
                L.marker(vet.coords, {icon: vetIcon}).addTo(map).bindPopup(popupContent);
            });
        }
        function switchTab(tab) {
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
            contentSections.forEach(section => section.classList.toggle('active', section.id === tab));
            window.location.hash = tab;
            if (tab === 'locator') initMap();
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = appData[lang] || appData.en;
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                const content = t[key];
                if(content === undefined) return;
                
                if (key === 'about_content' && Array.isArray(content)) {
                    el.innerHTML = '';
                    content.forEach((p, index) => {
                        const p_element = document.createElement('p');
                        p_element.className = 'about-p';
                        p_element.innerHTML = p;
                        el.appendChild(p_element);
                        
                        setTimeout(() => {
                            p_element.classList.add('visible');
                        }, index * 150);
                    });
                } else if (el.tagName === 'UL') {
                    el.innerHTML = content;
                } else {
                    el.innerHTML = content;
                }
            });
            document.getElementById('animal-name').placeholder = t.animal_name_placeholder;
            localStorage.setItem(LANG_STORAGE_KEY, lang);
            renderAllDynamicContent();
        }

        function renderAllDynamicContent() {
            renderHealthTipsGrid();
            populateAnimalCategorySelect();
            renderAllSchedules();
            renderStaticSchedules();
        }
        function renderHealthTipsGrid() {
            const t = appData[currentLang]; const tips = t.healthTips; tipsGrid.innerHTML = '';
            const animalOrder = ['cow', 'sheep_goat', 'pig', 'dog', 'cat'];
            animalOrder.forEach(key => {
                const animal = tips[key]; if (!animal) return;
                const card = document.createElement('div');
                card.className = 'bg-white/80 p-4 rounded-lg shadow-md border text-center cursor-pointer hover:shadow-xl hover:border-brand transform hover:-translate-y-1 transition-all';
                card.dataset.animalKey = key;
                card.innerHTML = `<img src="${animalImages[key]}" alt="${animal.title}" class="w-20 h-20 mx-auto mb-2 object-contain"><h3 class="font-bold text-brand">${animal.title}</h3>`;
                tipsGrid.appendChild(card);
            });
            reminderCard.innerHTML = `<h4 class="font-bold">${tips.vaxiliv_reminder.title}</h4><p>${tips.vaxiliv_reminder.content}</p>`;
        }
        function openHealthTipModal(animalKey) {
            const t = appData[currentLang]; const animalData = t.healthTips[animalKey]; if (!animalData) return;
            healthModalHeader.innerHTML = `<div class="flex items-center space-x-3"><img src="${animalImages[animalKey]}" alt="${animalData.title}" class="w-10 h-10 object-contain"><h2 class="text-xl font-bold text-brand">${animalData.title}</h2></div><button id="modal-close-x" class="text-2xl font-bold p-2 leading-none">&times;</button>`;
            let bodyHtml = `<div class="mb-6"><h3 class="text-lg font-semibold border-b-2 pb-1 mb-2">${t.health_tip_feeding}</h3><p class="whitespace-pre-line">${animalData.feeding_management}</p></div><div><h3 class="text-lg font-semibold border-b-2 pb-1 mb-3">${t.health_tip_diseases}</h3><div class="space-y-4">`;
            animalData.diseases.forEach(d => { bodyHtml += `<div class="bg-white/80 p-3 rounded-lg border"><h4 class="font-bold text-md text-brand">${d.name}</h4>${d.local_name ? `<p class="text-sm italic text-gray-500 mb-2">${d.local_name}</p>` : ''}<strong>${t.health_tip_signs}:</strong><p class="text-sm mb-2">${d.signs}</p><strong>${t.health_tip_first_aid}:</strong><p class="text-sm mb-2">${d.first_aid}</p>${d.prevention ? `<strong>${t.health_tip_prevention}:</strong><p class="text-sm">${d.prevention}</p>` : ''}</div>`; });
            bodyHtml += '</div></div>';
            healthModalBody.innerHTML = bodyHtml;
            healthTipModal.classList.add('visible');
        }
        function closeHealthTipModal() { healthTipModal.classList.remove('visible'); }
        function saveAnimals() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(animals)); }
        function loadAnimals() { const stored = localStorage.getItem(APP_STORAGE_KEY); if (stored) animals = JSON.parse(stored); }
        function populateAnimalCategorySelect() { const t = appData[currentLang]; animalCategorySelect.innerHTML = `<option value="">${t.cat_select_category}</option><option value="small">${t.cat_small_animals}</option><option value="large">${t.cat_large_animals}</option><option value="poultry">${t.cat_poultry}</option>`; populateAnimalTypeSelect(); }
        function populateAnimalTypeSelect() {
            const t = appData[currentLang], category = animalCategorySelect.value, options = { small: ['dog', 'cat'], large: ['cow', 'goat', 'sheep', 'pig'], poultry: ['chicken'] };
            let html = `<option value="">${ category ? t.cat_select_type : t.cat_prompt_select_category }</option>`;
            if (category && options[category]) { options[category].forEach(key => { html += `<option value="${key}">${t['animal_' + key]}</option>`; }); }
            animalTypeSelect.innerHTML = html; updateAnimalIconPreview();
        }
        function updateAnimalIconPreview() { const type = animalTypeSelect.value; animalIconPreview.innerHTML = type && animalImages[type] ? `<img src="${animalImages[type]}" class="w-full h-full object-contain p-1">` : ''; }
        function handleAddAnimal() {
            const type = animalTypeSelect.value, name = document.getElementById('animal-name').value.trim(), dob = document.getElementById('animal-dob').value;
            if (!type) { showModal('modal_select_type'); return; } if (!name) { showModal('modal_enter_name'); return; } if (!dob) { showModal('modal_enter_dob'); return; }
            const keyCap = type.charAt(0).toUpperCase() + type.slice(1);
            const schedule = appData.en.schedules[keyCap] || [];
            animals.push({ id: Date.now().toString(), name, type, dob, completed: new Array(schedule.length).fill(false) });
            saveAnimals(); renderAllSchedules();
            document.getElementById('animal-name').value = ''; document.getElementById('animal-dob').value = ''; animalCategorySelect.value = ''; populateAnimalTypeSelect();
        }
        function renderAllSchedules() {
            schedulesContainer.innerHTML = animals.length === 0 ? `<p class="text-center text-gray-500 italic">Your tracked schedules will appear here.</p>` : '';
            if (animals.length > 0) animals.sort((a,b) => a.name.localeCompare(b.name)).forEach(renderScheduleCard);
            renderReminders();
        }
        function renderScheduleCard(animal) {
            const t = appData[currentLang], keyCap = animal.type.charAt(0).toUpperCase() + animal.type.slice(1), scheduleData = t.schedules[keyCap] || [];
            const card = document.createElement('div');
            card.className = 'bg-white/80 p-4 rounded-lg border shadow-lg'; card.dataset.id = animal.id;
            let tableHTML = `<div class="flex justify-between items-start mb-4"><div class="flex items-center space-x-4"><img src="${animalImages[animal.type]}" alt="${animal.type}" class="w-16 h-16 rounded-lg p-1 border-2 bg-gray-100 object-contain"><div><h3 class="font-bold text-xl text-brand">${animal.name}</h3><p class="text-md text-gray-600">${t[`animal_${animal.type}`]}</p></div></div><button class="remove-btn text-red-500 hover:text-red-700 text-2xl p-1 leading-none">&times;</button></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-emerald-50/80 text-brand"><tr><th class="p-2 w-10">${t.th_done}</th><th class="p-2">${t.th_vaccine}</th><th class="p-2">${t.th_due_date}</th></tr></thead><tbody>`;
            const dob = new Date(animal.dob), today = new Date(); today.setHours(0,0,0,0);
            scheduleData.forEach((item, index) => {
                const dueDate = getDueDate(dob, item.duration), isCompleted = animal.completed[index];
                let rowClass = isCompleted ? 'completed' : (dueDate < today ? 'pending' : (dueDate.getTime() <= today.getTime() + (7*24*60*60*1000) ? 'due' : ''));
                tableHTML += `<tr class="vaccine-row ${rowClass}" data-index="${index}"><td class="p-2 text-center"><input type="checkbox" class="h-5 w-5 rounded accent-brand" ${isCompleted ? 'checked' : ''}></td><td class="p-2 font-medium">${item.vaccine}</td><td class="p-2">${dueDate.toLocaleDateString()}</td></tr>`;
            });
            card.innerHTML = tableHTML + '</tbody></table></div>'; schedulesContainer.appendChild(card);
        }
        function handleScheduleInteraction(e) {
            const card = e.target.closest('[data-id]'); if (!card) return; const animal = animals.find(a => a.id === card.dataset.id); if (!animal) return;
            if (e.target.type === 'checkbox') { const idx = parseInt(e.target.closest('tr').dataset.index); animal.completed[idx] = e.target.checked; saveAnimals(); renderAllSchedules(); }
            else if (e.target.classList.contains('remove-btn')) { animals = animals.filter(a => a.id !== card.dataset.id); saveAnimals(); renderAllSchedules(); }
        }
        function getDueDate(startDate, weeks) { const date = new Date(startDate); date.setDate(date.getDate() + weeks * 7); return date; }
        function renderStaticSchedules() {
            const t = appData[currentLang], animalOrder = ['dog', 'cat', 'cow', 'goat', 'sheep', 'chicken', 'pig'];
            let contentHTML = '';
            animalOrder.forEach(key => {
                const keyCap = key.charAt(0).toUpperCase() + key.slice(1), schedule = t.schedules[keyCap]; if(!schedule || schedule.length === 0) return;
                let table = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-emerald-50/80 text-brand"><tr><th class="p-2">${t.th_vaccine}</th><th class="p-2">${t.th_age}</th></tr></thead><tbody>`;
                schedule.forEach(item => { table += `<tr class="border-b"><td class="p-2 font-medium">${item.vaccine}</td><td class="p-2">${item.age}</td></tr>`; });
                table += `</tbody></table></div>`;
                contentHTML += `<div class="accordion-item bg-white/80 border rounded-lg shadow-sm overflow-hidden"><button class="accordion-header w-full text-left p-4 font-semibold flex justify-between items-center"><span class="flex items-center"><img src="${animalImages[key]}" alt="${t['animal_'+key]}" class="w-12 h-12 rounded-md p-1 mr-4 bg-gray-100 object-contain"><span class="text-lg">${t['animal_'+key]}</span></span><svg class="w-6 h-6 transform transition-transform" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></button><div class="accordion-content px-4 pb-4">${table}</div></div>`;
            });
            staticSchedulesContainer.innerHTML = contentHTML;
            addAccordionListeners('#static-schedules-container');
        }
        function addAccordionListeners(selector) {
            document.querySelector(selector).querySelectorAll('.accordion-header').forEach(h => h.addEventListener('click', () => {
                const content = h.nextElementSibling; const open = content.style.maxHeight;
                document.querySelector(selector).querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                if (!open || open === "0px") content.style.maxHeight = content.scrollHeight + 'px';
            }));
        }
        function updateNotificationUI() {
            const t = appData[currentLang];
            if (!('Notification' in window)) { enableNotificationsBtn.style.display='none'; return; }
            switch (Notification.permission) { case 'granted': enableNotificationsBtn.style.display='none'; notificationStatus.textContent=t.reminders_status_granted; break; case 'denied': enableNotificationsBtn.style.display='none'; notificationStatus.textContent=t.reminders_status_denied; break; default: enableNotificationsBtn.style.display='flex'; notificationStatus.textContent=''; break; }
        }
        function requestNotificationPermission() { Notification.requestPermission().then(p => { updateNotificationUI(); if (p === 'granted') new Notification('Vaxiliv Reminders', { body: 'You will now receive reminders!', icon: 'assets/images/icons/icon-192.png' }); }); }
        function renderReminders() {
            const t = appData[currentLang], reminders = [], today = new Date(); today.setHours(0,0,0,0);
            const sevenDays = new Date(today); sevenDays.setDate(today.getDate() + 7);
            animals.forEach(animal => {
                const keyCap = animal.type.charAt(0).toUpperCase() + animal.type.slice(1);
                (appData.en.schedules[keyCap]||[]).forEach((item, index) => { if (!animal.completed[index]) { const due = getDueDate(new Date(animal.dob), item.duration); if (due <= sevenDays) reminders.push({ animal, item, due }); } });
            });
            reminders.sort((a, b) => a.due - b.due);
            upcomingVaccinationsList.innerHTML = reminders.length === 0 ? `<p class="text-sm text-center italic">${t.reminders_no_upcoming}</p>` : '';
            reminders.forEach(({ animal, item, due }) => {
                const diff = Math.ceil((due - today) / 864e5);
                let statusText = diff < 0 ? t.reminders_overdue : `${t.reminders_due_in} ${diff} ${t.reminders_days}`;
                let statusClass = diff < 0 ? 'text-red-600' : 'text-yellow-700';
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-2 bg-white/80 rounded-md border';
                el.innerHTML = `<div class="flex items-center space-x-3"><img src="${animalImages[animal.type]}" alt="${animal.type}" class="w-8 h-8 object-contain"><div><p class="font-semibold text-sm">${item.vaccine}</p><p class="text-xs text-gray-600">${animal.name}</p></div></div><p class="text-xs font-medium ${statusClass}">${statusText}</p>`;
                upcomingVaccinationsList.appendChild(el);
            });
        }
        function showModal(messageKey) { modalMessage.textContent = appData[currentLang][messageKey]; modal.classList.add('visible'); }
        function hideModal() { modal.classList.remove('visible'); }

        navButtons.forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        languageSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));
        tipsGrid.addEventListener('click', (e) => { const c = e.target.closest('[data-animal-key]'); if (c) openHealthTipModal(c.dataset.animalKey); });
        healthModalCloseBtn.addEventListener('click', closeHealthTipModal);
        healthTipModal.addEventListener('click', (e) => { if (e.target === healthTipModal) closeHealthTipModal(); });
        healthModalHeader.addEventListener('click', (e) => { if (e.target.id === 'modal-close-x') closeHealthTipModal(); });
        animalCategorySelect.addEventListener('change', populateAnimalTypeSelect);
        addAnimalBtn.addEventListener('click', handleAddAnimal);
        schedulesContainer.addEventListener('click', handleScheduleInteraction);
        enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
        modalCloseBtn.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) hideModal(); });

        async function init() {
            const splashScreen = document.getElementById('splash-screen');
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 700);
            }, 2000);

            const dataLoaded = await loadData();
            if (!dataLoaded) return;

            loadAnimals();
            const savedLang = localStorage.getItem(LANG_STORAGE_KEY) || 'en';
            languageSwitcher.value = savedLang;
            setLanguage(savedLang);
            updateNotificationUI();
            const tab = window.location.hash.substring(1);
            if (tab && document.querySelector(`[data-tab="${tab}"]`)) {
                switchTab(tab);
            } else {
                switchTab('tips');
            }
        }
        
        init();
    });
</script>
</body>
</html>
